apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: project-m-dev
spec:
  selector:
    matchLabels:
      app: kafka
  serviceName: "kafka-service"
  replicas: 1
  template:
    metadata:
      labels:
        app: kafka
    spec:
      containers:
        - name: kafka
          image: debezium/kafka
          ports:
            - containerPort: 9092
              name: kafka
          env:
            - name: BROKER_ID
              value: "0"
            - name: ZOOKEEPER_CONNECT
              value: "host.docker.internal:2181"
            - name: KAFKA_ADVERTISED_LISTENERS
              value: "PLAINTEXT://kafka-service:9092"
---
apiVersion: v1
kind: Service
metadata:
  name: kafka-service
  namespace: project-m-dev
spec:
  selector:
    app: kafka
  ports:
    - protocol: TCP
      port: 9092
      targetPort: 9092
---
apiVersion: batch/v1
kind: Job
metadata:
  name: init
  namespace: project-m-dev
spec:
  template:
    spec:
      containers:
        - name: init
          image: confluentinc/cp-kafka:7.4.1
          command: ["/bin/sh", "-c"]
          args:
            - |
              kafka-topics --bootstrap-server kafka-service:9092 --list

              echo -e 'Creating kafka topics'

              kafka-topics --bootstrap-server kafka-service:9092 --create --if-not-exists --topic topic_projectm_cmd_persist --replication-factor 1 --partitions 1
              kafka-topics --bootstrap-server kafka-service:9092 --create --if-not-exists --topic topic_projectm_cmd_insights_gather --replication-factor 1 --partitions 1
              kafka-topics --bootstrap-server kafka-service:9092 --create --if-not-exists --topic topic_projectm_cmd_insights_structure --replication-factor 1 --partitions 1
              kafka-topics --bootstrap-server kafka-service:9092 --create --if-not-exists --topic topic_projectm_cmd_azdo_proxy --replication-factor 1 --partitions 1

              echo -e 'Successfully created the following topics:'
              kafka-topics --bootstrap-server kafka-service:9092 --list
      restartPolicy: OnFailure
  backoffLimit: 4
